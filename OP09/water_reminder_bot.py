import telebot
from datetime import datetime, time
import random
import threading
import schedule
import time as time_module

# –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –æ—Ç @BotFather
BOT_TOKEN = "8511275790:AAFV9DjuS-NA6o0mTZDTIq-iUJycwFWwZqI"
bot = telebot.TeleBot(BOT_TOKEN)

# –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
active_users = set()

# 5 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –æ –≤–æ–¥–µ
WATER_FACTS = [
    "üíß –í–æ–¥–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –æ–∫–æ–ª–æ 60% –º–∞—Å—Å—ã —Ç–µ–ª–∞ –≤–∑—Ä–æ—Å–ª–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –≤–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å!",
    "üåä –ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π –º–æ–∑–≥ –Ω–∞ 73% —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –≤–æ–¥—ã. –ü–µ–π—Ç–µ –≤–æ–¥—É, —á—Ç–æ–±—ã –¥—É–º–∞—Ç—å –ª—É—á—à–µ!",
    "‚ú® –ü–∏—Ç—å–µ–≤–∞—è –≤–æ–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–∫—Å–∏–Ω—ã –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –∏ —É–ª—É—á—à–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–∂–∏.",
    "üí™ –î–∞–∂–µ –ª–µ–≥–∫–æ–µ –æ–±–µ–∑–≤–æ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞ 1-2% –º–æ–∂–µ—Ç —Å–Ω–∏–∑–∏—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é.",
    "üå°Ô∏è –í–æ–¥–∞ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ —Ç–µ—Ä–º–æ—Ä–µ–≥—É–ª—è—Ü–∏–∏ –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –∏ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞."
]

# –í—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (5 —Ä–∞–∑ –≤ –¥–µ–Ω—å)
REMINDER_TIMES = [
    "09:00",  # –£—Ç—Ä–æ
    "12:00",  # –û–±–µ–¥
    "15:00",  # –ü–æ–ª–¥–µ–Ω—å
    "18:00",  # –í–µ—á–µ—Ä
    "21:00"   # –ü–µ—Ä–µ–¥ —Å–Ω–æ–º
]

@bot.message_handler(commands=['start'])
def send_welcome(message):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    chat_id = message.chat.id
    active_users.add(chat_id)
    
    welcome_text = (
        "üåä –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞ –æ –ø–∏—Ç—å–µ –≤–æ–¥—ã!\n\n"
        "–Ø –±—É–¥—É –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å —Ç–µ–±–µ –ø–∏—Ç—å –≤–æ–¥—É 5 —Ä–∞–∑ –≤ –¥–µ–Ω—å:\n"
        f"‚è∞ {', '.join(REMINDER_TIMES)}\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
        "/stop - –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è\n"
        "/fact - –ü–æ–ª—É—á–∏—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π —Ñ–∞–∫—Ç –æ –≤–æ–¥–µ\n"
        "/schedule - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π\n\n"
        "üíß –ù–µ –∑–∞–±—ã–≤–∞–π –ø–∏—Ç—å –≤–æ–¥—É —Ä–µ–≥—É–ª—è—Ä–Ω–æ!"
    )
    
    bot.reply_to(message, welcome_text)

@bot.message_handler(commands=['stop'])
def stop_reminders(message):
    """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    chat_id = message.chat.id
    if chat_id in active_users:
        active_users.remove(chat_id)
        bot.reply_to(message, "‚ùå –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã. –ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Å–Ω–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π /start")
    else:
        bot.reply_to(message, "–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —É–∂–µ –æ—Ç–∫–ª—é—á–µ–Ω—ã.")

@bot.message_handler(commands=['fact'])
def send_fact(message):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ñ–∞–∫—Ç–∞ –æ –≤–æ–¥–µ"""
    fact = random.choice(WATER_FACTS)
    bot.reply_to(message, fact)

@bot.message_handler(commands=['schedule'])
def show_schedule(message):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    schedule_text = (
        "üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –≤–æ–¥–µ:\n\n"
        + "\n".join([f"‚è∞ {time}" for time in REMINDER_TIMES])
    )
    bot.reply_to(message, schedule_text)

def send_water_reminder():
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    if not active_users:
        return
    
    fact = random.choice(WATER_FACTS)
    reminder_text = (
        "üíß –ü–æ—Ä–∞ –ø–æ–ø–∏—Ç—å –≤–æ–¥—ã!\n\n"
        f"{fact}\n\n"
        "–í—ã–ø–µ–π —Å—Ç–∞–∫–∞–Ω –≤–æ–¥—ã –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! ü•§"
    )
    
    for chat_id in active_users.copy():
        try:
            bot.send_message(chat_id, reminder_text)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}: {e}")

def schedule_reminders():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"""
    for reminder_time in REMINDER_TIMES:
        schedule.every().day.at(reminder_time).do(send_water_reminder)
    
    print(f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –≤—Ä–µ–º—è: {', '.join(REMINDER_TIMES)}")
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    while True:
        schedule.run_pending()
        time_module.sleep(30)  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    
    # –ó–∞–ø—É—Å–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    scheduler_thread = threading.Thread(target=schedule_reminders, daemon=True)
    scheduler_thread.start()
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    bot.infinity_polling()

if __name__ == "__main__":
    main()
